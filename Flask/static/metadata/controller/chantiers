{
    "type": "Ext.app.Controller",
    "reference": {
        "name": "items",
        "type": "array"
    },
    "codeClass": null,
    "userConfig": {
        "designer|userClassName": "chantiers",
        "models": [
            "chantier"
        ],
        "stores": [
            "chantiers",
            "clients",
            "chantiers_hours"
        ]
    },
    "designerId": "5358e90e-5181-4e9f-bc2d-6b13a5016669",
    "cn": [
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "loadClients",
                "implHandler": [
                    "var store = this.getClientsStore();",
                    "var promise = new RSVP.Promise(function(resolve, reject) {",
                    "    store.load({",
                    "        callback:function(){",
                    "            resolve();",
                    "        }",
                    "    });",
                    "});",
                    "return promise;"
                ]
            },
            "name": "loadClients",
            "designerId": "23e0c222-2574-4192-a879-eec579d22e0e"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "refreshHoursGrid",
                "implHandler": [
                    "//On verifie qu'un record de chantier est selectionne",
                    "var chantierGrid = this.getChantiersGrid();",
                    "var selection = chantierGrid.getSelectionModel().getSelection();",
                    "if (selection.length == 1) {",
                    "    var hours_store = this.getChantiers_hoursStore();",
                    "    hours_store.load({",
                    "        params:{chantierId:selection[0].data.id}",
                    "    });",
                    "}",
                    ""
                ]
            },
            "name": "refreshHoursGrid",
            "designerId": "868c3018-dd2f-4118-a51a-32e34406a34e"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "chantiersGrid",
                "selector": "#chantiersGrid"
            },
            "name": "chantiersGrid",
            "designerId": "83598cc4-c7b0-40f6-80cf-247af2dbed33"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#chantiersGrid #addChantier",
                "designer|targetType": "Ext.button.Button",
                "fn": "onAddClick",
                "implHandler": [
                    "Ext.widget('editChantierWindow').show();"
                ],
                "name": "click",
                "scope": "me"
            },
            "name": "onAddClick",
            "designerId": "6658bd78-b47e-4897-9312-f544968c7ccb"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#editChantierWindow #annuler",
                "designer|targetType": "Ext.button.Button",
                "fn": "onAnnulerClick",
                "implHandler": [
                    "button.up('window').close();"
                ],
                "name": "click",
                "scope": "me"
            },
            "name": "onAnnulerClick",
            "designerId": "3383f85d-7079-473b-9446-f506eb491924"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#chantiersGrid",
                "designer|targetType": "Ext.grid.Panel",
                "fn": "onChantiersGridSelect",
                "implHandler": [
                    "this.refreshHoursGrid();",
                    ""
                ],
                "name": "select",
                "scope": "me"
            },
            "name": "onChantiersGridSelect",
            "designerId": "69ac67de-821c-41f0-85ef-25f51d37aad8"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#editChantierWindow #enregistrer",
                "designer|targetType": "Ext.button.Button",
                "fn": "onEnregistrerClick",
                "implHandler": [
                    "//On va chercher les infos du form",
                    "var myForm = Ext.getCmp('editChantierWindow').down('form').getForm();",
                    "if (! myForm.isValid()) {",
                    "    return;",
                    "}",
                    "",
                    "",
                    "var record = myForm.getRecord();",
                    "if (!record) {",
                    "    var chantierModel = this.getChantierModel();    ",
                    "    record = new chantierModel();",
                    "}",
                    "record.set(myForm.getValues());",
                    "if (!record.get('id')) {",
                    "    //POST",
                    "    record.getProxy().appendId=false; //bug fix pour eviter d'appender un slah a la fin de l'url",
                    "}",
                    "record.save({",
                    "    scope:this,",
                    "    callback:function(){",
                    "        button.up('window').close();",
                    "        this.getChantiersGrid().store.load();",
                    "    }",
                    "});",
                    "record.getProxy().appendId=true;"
                ],
                "name": "click",
                "scope": "me"
            },
            "name": "onEnregistrerClick",
            "designerId": "cb8bca32-8a03-40f6-b9cb-3e4a349ba73f"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#chantiersPanel",
                "designer|targetType": "Ext.panel.Panel",
                "fn": "onChantiersPanelActivate",
                "implHandler": [
                    "var me =this;",
                    "me.loadClients().then(function(){",
                    "    me.getChantiersStore().load();",
                    "    me.refreshHoursGrid();",
                    "});",
                    "",
                    "",
                    ""
                ],
                "name": "activate",
                "scope": "me"
            },
            "name": "onChantiersPanelActivate",
            "designerId": "bda2d797-fba0-4b5a-ab6d-f500595d7582"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#editChantier",
                "designer|targetType": "Ext.button.Button",
                "fn": "onEditChantierClick",
                "implHandler": [
                    "//On prend le record selectionne",
                    "var selectedRecord = this.getChantiersGrid().selModel.getSelection()[0];",
                    "if (!selectedRecord) {",
                    "    Ext.Msg.alert('Attention','Vous devez selectionner un chantier...').setWidth(200);",
                    "    return;",
                    "}",
                    "",
                    "//On affiche la fenetre d'edit",
                    "var editChantierWindow = Ext.widget('editChantierWindow');",
                    "",
                    "//On load le soustraitant selecitonne dans le form",
                    "var myForm = editChantierWindow.down('form');",
                    "",
                    "//On retourne chercher le data dans la db, au cas ou un autre user ait modifie la fiche",
                    "var chantierModel = this.getChantierModel();   ",
                    "chantierModel.load(selectedRecord.get('id'),{",
                    "    scope:this,",
                    "    callback:function(chantier){",
                    "        myForm.getForm().loadRecord(chantier);",
                    "    }",
                    "});",
                    "",
                    "editChantierWindow.show();",
                    ""
                ],
                "name": "click",
                "scope": "me"
            },
            "name": "onEditChantierClick",
            "designerId": "280ed5d0-cfc7-4ac4-a42b-b5d85f6b85e4"
        }
    ]
}