{
    "type": "Ext.app.Controller",
    "reference": {
        "name": "items",
        "type": "array"
    },
    "codeClass": null,
    "userConfig": {
        "designer|userClassName": "sousTraitants",
        "models": [
            "sousTraitant"
        ],
        "stores": [
            "sousTraitants",
            "specialites",
            "chantiers",
            "specialitesLinkSoustraitants"
        ],
        "views": [
            "editSousTraitantWindow",
            "windowAddSpecialite"
        ]
    },
    "designerId": "d61f7263-e573-4a70-9e2e-e9dc378117e0",
    "cn": [
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#sousTraitantsGrid #searchText",
                "designer|targetType": "Ext.form.field.Text",
                "fn": "onTextfieldChange",
                "implHandler": [
                    "this.refreshGrid()",
                    ".then(function(){",
                    "    field.focus();",
                    "});",
                    ""
                ],
                "name": "change",
                "scope": "me"
            },
            "name": "onTextfieldChange",
            "designerId": "fc4f5a1b-743f-40f3-afc7-70868fdb1952"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|params": [
                    "specialite",
                    "operation"
                ],
                "fn": "addOrRemoveSpecialite",
                "implHandler": [
                    "",
                    "if (operation === 'add') {",
                    "    this.currentSpecialites.push({name:specialite});",
                    "",
                    "}",
                    "else if (operation === 'remove') {",
                    "",
                    "    this.currentSpecialites = Ext.Array.filter(this.currentSpecialites, function(s){",
                    "        return s.name != specialite;    ",
                    "    });",
                    "}",
                    "this.loadSpecialiteLinkSoustraitantsStore(this.currentSpecialites);",
                    ""
                ]
            },
            "name": "addOrRemoveSpecialite",
            "designerId": "70087465-5850-43e1-9384-bd3f51d8aa53"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "refreshGrid",
                "implHandler": [
                    "var me = this;",
                    "",
                    "return me.reloadSousTraitantsStore()",
                    ".then(function(){",
                    "    var store = me.getSousTraitantsStore();",
                    "    store.clearFilter(true);",
                    "    me.applyQuickSearch();",
                    "    me.applySpecialiteFilter();",
                    "\treturn RSVP.resolve();",
                    "});",
                    ""
                ]
            },
            "name": "refreshGrid",
            "designerId": "bfe5ee6f-eb49-435f-ac60-699159e8c8b3"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|params": [
                    "specialites"
                ],
                "fn": "loadSpecialiteLinkSoustraitantsStore",
                "implHandler": [
                    "var store = this.getSpecialitesLinkSoustraitantsStore();",
                    "store.removeAll();",
                    "",
                    "store.loadData(specialites);",
                    ""
                ]
            },
            "name": "loadSpecialiteLinkSoustraitantsStore",
            "designerId": "6c2c6a2c-a15f-4090-996b-f16885bc5176"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "init",
                "implHandler": [
                    "this.currentSpecialites = [];"
                ]
            },
            "name": "init",
            "designerId": "f1ae16ca-2864-473e-99b5-1051d9898cf3"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "editSousTraitant",
                "implHandler": [
                    "//On prend le record selectionne",
                    "var selectedRecord = this.getSousTraitantsGrid().selModel.getSelection()[0];",
                    "",
                    "if (!selectedRecord) {",
                    "    Ext.Msg.alert('Attention','Vous devez selectionner un sous traitant...').setWidth(200);",
                    "    return;",
                    "}",
                    "",
                    "",
                    "//On retourne chercher le data dans la db, au cas ou un autre user ait modifie la fiche",
                    "var sousTraitantModel = this.getSousTraitantModel();",
                    "sousTraitantModel.load(selectedRecord.get('id'),{",
                    "    callback:function(sousTraitant){",
                    "        myForm.getForm().loadRecord(sousTraitant);",
                    "    }",
                    "});",
                    "",
                    "",
                    "",
                    "//On affiche la fenetre",
                    "var editSousTraitantWindow = Ext.widget('editSousTraitantWindow');",
                    "",
                    "editSousTraitantWindow.show();",
                    "",
                    "//On load le soustraitant selecitonne dans le form",
                    "var myForm = editSousTraitantWindow.down('form');",
                    "",
                    "this.currentSpecialites = Ext.clone(selectedRecord.get('specialites'));",
                    "this.loadSpecialiteLinkSoustraitantsStore(this.currentSpecialites);"
                ]
            },
            "name": "editSousTraitant",
            "designerId": "1734ae33-2334-400e-99fb-62f322a00b7d"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|params": [
                    "params"
                ],
                "fn": "reloadSousTraitantsStore",
                "implHandler": [
                    "var me = this;",
                    "var promise = new RSVP.Promise(function(resolve, reject) {",
                    "    var store = me.getSousTraitantsStore();",
                    "    store.removeAll();",
                    "    store.getProxy().extraParams = params;",
                    "    store.load({",
                    "        callback:function(){",
                    "            resolve();",
                    "        }",
                    "    });",
                    "",
                    "});",
                    "",
                    "return promise;",
                    ""
                ]
            },
            "name": "reloadSousTraitantsStore",
            "designerId": "f21b65be-3f0b-4381-a43a-a8e7d9d7cc9f"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "filterSousTraitantsStoreWithText",
                "implHandler": [
                    "//On va chercher la valeur du text search",
                    "var newValue = this.getSearchField().value;",
                    "",
                    "var sousTraitantsStore = this.getSousTraitantsGrid().store;",
                    "sousTraitantsStore.clearFilter();",
                    "sousTraitantsStore.filter([",
                    "{filterFn: function(item) {",
                    "    if (item.get(\"name\") )",
                    "    {",
                    "        return (item.get(\"name\").toLowerCase().indexOf(newValue.toLowerCase()) != -1);",
                    "    }",
                    "    return false;",
                    "}}",
                    "",
                    "]);",
                    "",
                    "",
                    ""
                ]
            },
            "name": "filterSousTraitantsStoreWithText",
            "designerId": "c35991d6-6d30-4083-b208-e188492a3448"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|params": [
                    "btn",
                    "text"
                ],
                "fn": "confirmAddSousTraitant",
                "implHandler": [
                    "if (btn == 'ok')",
                    "{",
                    "    var model = this.getSousTraitantModel();",
                    "",
                    "    // create a record",
                    "    var newRecord = Ext.create(model);",
                    "    newRecord.data.name = text;",
                    "    SousTraitants.create(newRecord.data,function(){",
                    "        this.getSearchField().setValue(text);",
                    "    },this);",
                    "",
                    "",
                    "}"
                ]
            },
            "name": "confirmAddSousTraitant",
            "designerId": "eae68ef9-19f6-49dc-a1d2-c2eb7188b737"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "getSelectedSousTraitant",
                "implHandler": [
                    "var sousTraitantGrid = Ext.ComponentQuery.query('#sousTraitantsGrid');",
                    "if (sousTraitantGrid[0].selModel.selected.items)",
                    "{",
                    "    return sousTraitantGrid[0].selModel.selected.items[0];",
                    "",
                    "}",
                    "return false;",
                    ""
                ]
            },
            "name": "getSelectedSousTraitant",
            "designerId": "dc52b804-9e86-4a66-8bd7-8ae34522c9d5"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "applySpecialiteFilter",
                "implHandler": [
                    "//On prend la valeur du comboSpecialite",
                    "var specialiteId = this.getComboSpecialites().getValue();",
                    "",
                    "if ( specialiteId && specialiteId > 0) {",
                    "",
                    "    var store = this.getSousTraitantsStore();",
                    "    store.filter([",
                    "    {filterFn: function(item) {",
                    "        return Ext.Array.contains(",
                    "        Ext.Array.pluck(item.get('specialites'), 'id'),",
                    "        specialiteId",
                    "        );",
                    "    }}",
                    "    ]);",
                    "}"
                ]
            },
            "name": "applySpecialiteFilter",
            "designerId": "6f52465e-caed-456f-86a6-ef1d754a29a0"
        },
        {
            "type": "basicfunction",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "fn": "applyQuickSearch",
                "implHandler": [
                    "var newValue = this.getSearchField().getValue();",
                    "//On filtre le store en local",
                    "var regFind = new RegExp(newValue,\"i\");",
                    "var store = this.getSousTraitantsStore();",
                    "store.filter([",
                    "{filterFn: function(item) {",
                    "    return (regFind.test(item.get(\"name\")) || regFind.test(item.get(\"contactName\"))  );",
                    "}}",
                    "]);"
                ]
            },
            "name": "applyQuickSearch",
            "designerId": "96185a27-c824-4708-a833-e79ccff4e1a1"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "searchField",
                "selector": "#sousTraitantsGrid #searchText"
            },
            "name": "searchField",
            "designerId": "1c978560-cbc4-4472-bd8a-908a7f912411"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "comboSpecialites",
                "selector": "#comboSpecialites"
            },
            "name": "comboSpecialites",
            "designerId": "e9c66df6-cd8a-4f76-9b09-987acebada5a"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "comboAddSpecialites",
                "selector": "#comboAddSpecialites"
            },
            "name": "comboAddSpecialites",
            "designerId": "3ee71282-905e-41a8-a99e-dfb736dd9cee"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "sousTraitantsGrid",
                "selector": "#sousTraitantsGrid"
            },
            "name": "sousTraitantsGrid",
            "designerId": "a9426fb5-af18-471d-8e9e-d59c79fe1788"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#sousTraitantsGrid #refresh",
                "designer|targetType": "Ext.panel.Tool",
                "fn": "onRefreshClick",
                "implHandler": [
                    "this.reloadSousTraitantsStore();"
                ],
                "name": "click",
                "scope": "me"
            },
            "name": "onRefreshClick",
            "designerId": "7c3ed28c-25ef-492c-bc37-fdc2a5c0b760"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#sousTraitantsGrid #comboSpecialites",
                "designer|targetType": "Ext.form.field.ComboBox",
                "fn": "onComboSpecialitesSelect",
                "implHandler": [
                    "this.refreshGrid();",
                    ""
                ],
                "name": "select",
                "scope": "me"
            },
            "name": "onComboSpecialitesSelect",
            "designerId": "319b3b43-e05a-44bf-809a-bc03d7dafa38"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#sousTraitantsPanel",
                "designer|targetType": "Ext.panel.Panel",
                "fn": "onSousTraitantsPanelActivate",
                "implHandler": [
                    "this.refreshGrid();",
                    ""
                ],
                "name": "activate",
                "scope": "me"
            },
            "name": "onSousTraitantsPanelActivate",
            "designerId": "b6b68c57-f757-4f4a-a226-f8945e7d76d2"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#addSousTraitant",
                "designer|targetType": "Ext.button.Button",
                "fn": "onAddSousTraitantClick",
                "implHandler": [
                    "//On s'assure que le store des links specialites/sous traitant est vide",
                    "//var myStore = Ext.getStore('specialiteLinkSousTraitant');",
                    "//myStore.proxy.extraParams = '';",
                    "//myStore.removeAll();",
                    "this.currentSpecialites = [];",
                    "this.loadSpecialiteLinkSoustraitantsStore(this.currentSpecialites);",
                    "Ext.widget('editSousTraitantWindow').show();"
                ],
                "name": "click",
                "scope": "me"
            },
            "name": "onAddSousTraitantClick",
            "designerId": "a5f182ca-a227-4b6a-8089-70e529444525"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#editSousTraitant",
                "designer|targetType": "Ext.button.Button",
                "fn": "onEditSousTraitantClick",
                "implHandler": [
                    "this.editSousTraitant();"
                ],
                "name": "click",
                "scope": "me"
            },
            "name": "onEditSousTraitantClick",
            "designerId": "74c47f80-6a2f-489c-8ba6-e3a47f8b967a"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "editSousTraitantWindow #annuler",
                "designer|targetType": "Ext.button.Button",
                "fn": "onAnnulerClick",
                "implHandler": [
                    "button.up('window').close();"
                ],
                "name": "click",
                "scope": "me"
            },
            "name": "onAnnulerClick",
            "designerId": "15d09e58-9a84-481a-9cff-dae54fe08350"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "editSousTraitantWindow #enregistrer",
                "designer|targetType": "Ext.button.Button",
                "fn": "onEnregistrerClick",
                "implHandler": [
                    "//On va chercher les infos du form",
                    "var myForm = Ext.getCmp('editSousTraitantWindow').down('form').getForm();",
                    "if (! myForm.isValid()) {",
                    "    return;",
                    "}",
                    "var record = myForm.getRecord();",
                    "",
                    "if (!record) {",
                    "    var sousTraitantModel = this.getSousTraitantModel();",
                    "    record = new sousTraitantModel();",
                    "}",
                    "record.set(myForm.getValues());",
                    "",
                    "//Un peu broche a fouin...",
                    "var store = this.getSpecialitesLinkSoustraitantsStore();",
                    "record.set('specialites', store.collect('name'));",
                    "",
                    "if (! record.get('id')) {",
                    "    //POST",
                    "    record.getProxy().appendId=false; //bug fix pour eviter d'appender un slah a la fin de l'url",
                    "}",
                    "",
                    "record.save({",
                    "    scope:this,",
                    "    callback:function(){",
                    "        button.up('window').close();",
                    "        this.refreshGrid();",
                    "        this.getComboSpecialites().store.load(); //refresh du combo des categories",
                    "    }",
                    "});",
                    "",
                    "record.getProxy().appendId=true;"
                ],
                "name": "click",
                "scope": "me"
            },
            "name": "onEnregistrerClick",
            "designerId": "2750860c-74a8-403e-ac76-560c89e1e52e"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "#addSpecialite",
                "designer|targetType": "Ext.button.Button",
                "fn": "onAddSpecialiteClick",
                "implHandler": [
                    "var specialite = this.getComboAddSpecialites().getValue();",
                    "this.addOrRemoveSpecialite(specialite, 'add');",
                    "button.up('window').close();"
                ],
                "name": "click",
                "scope": "me"
            },
            "name": "onAddSpecialiteClick",
            "designerId": "9c046a8d-8e6f-41b2-837a-52d03c90483b"
        }
    ]
}